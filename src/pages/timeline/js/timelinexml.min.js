!function(a){function b(a){this.rawData=new Array,this.src=a.src,this.eventTagName=a.eventTagName,this.dateTagName=a.dateTagName,this.titleTagName=a.titleTagName,this.thumbTagName=a.thumbTagName,this.contentTagName=a.contentTagName,this.linkTagName=a.linkTagName,this.htmlEventClassName=a.htmlEventClassName,this.htmlDateClassName=a.htmlDateClassName,this.htmlTitleClassName=a.htmlTitleClassName,this.htmlContentClassName=a.htmlContentClassName,this.htmlLinkClassName=a.htmlLinkClassName,this.htmlThumbClassName=a.htmlThumbClassName,this.events=new Array,this.xmlDoc=1,this.allMonths=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],this.nYears=0,this.nMonths=0,this.nDays=0,this.startYear=3e4,this.endYear=0}function c(a){this.eventPositions=new Array,this.eventNodeWidth=0,this.width=0,this.yearWidth=0,this.monthWidth=0,this.dayWidth=0,this.hourWidth=0,this.minuteWidth=0,this.secondWidth=0,this.showYears=!1,this.showMonths=!1,this.showEveryNthMonth=1,this.showEveryNthYear=1,this.showDays=!1,this.showHours=!1,this.showMinutes=!1,this.showSeconds=!1,this.nLargeScale=0,this.nSmallScale=0,this.step=0,this.monthId=0,this.monthPosition=0,this.yearPosition=0,this.yearId=0,this.selectedEvent=0,this.selectedEventContentsWidth=0,this.eventMargin=0}function d(){this.selectedEventContentsWidth=0}var e,f,g,h={lim:function(a,b,c){return b>a?a=b:a>c&&(a=c),a}};b.prototype.loadXML=function(b){var c=this;a.get(c.src,function(a){c.xmlDoc=a,b.callback()})},b.prototype.getXMLContent=function(){for(var b=this.xmlDoc.getElementsByTagName(this.eventTagName),c=0;c<b.length;c++){var d='<a href="'+a(b[c]).find(this.linkTagName).find("a").attr("href")+'">'+a(b[c]).find(this.linkTagName).find("a").text()+"</a>";this.rawData[c]={date:a(b[c]).find(this.dateTagName).text(),title:a(b[c]).find(this.titleTagName).text(),thumb:a(b[c]).find(this.thumbTagName).text(),content:a(b[c]).find(this.contentTagName).text(),link:d}}},b.prototype.getHTMLContent=function(){for(var b=a("."+this.htmlEventClassName),c=0;c<b.length;c++)this.rawData[c]={date:a(b[c]).find("."+this.htmlDateClassName).html(),title:a(b[c]).find("."+this.htmlTitleClassName).html(),thumb:"",content:a(b[c]).find("."+this.htmlContentClassName).html(),link:a(b[c]).find("."+this.htmlLinkClassName).html()},0!=a(b[c]).find("."+this.htmlThumbClassName).length&&(this.rawData[c].thumb=a(b[c]).find("."+this.htmlThumbClassName).html())},b.prototype.parseRawData=function(){for(var a,b,c,d=this,e=0;e<d.rawData.length;e++){if(-1==d.rawData[e].date.search("BC")){var f=d.rawData[e].date,g=f.split(".");a=g[0],c=g[1],b=parseInt(g[2]);var h=0;h=0==parseInt(a[0])?parseInt(a[1]):parseInt(a);var i=0;i=0==parseInt(c[0])?parseInt(c[1]):parseInt(c);var j=a+"."+c+"."+b}else{var j=d.rawData[e].date;b=parseInt("-"+d.rawData[e].date.replace(" ","").replace("BC",""))}var k=30,l=d.rawData[e].title;l.length>k&&(l=l.slice(0,k),l+="...");var m=!1;if(""!=d.rawData[e].thumb){m=!0;var n='<img src="'+d.rawData[e].thumb+'">'}var o=400,p=d.rawData[e].content;p.length>o&&(p=p.slice(0,o),p+="..."),d.events[e]={id:e,datestring:j,date:h,year:b,month:i,title:l,content:p,link:d.rawData[e].link,hasThumb:m,thumb:n}}for(var e=0;e<d.events.length;e++)parseInt(d.events[e].year)>d.endYear&&(d.endYear=parseInt(d.events[e].year));for(var e=0;e<d.events.length;e++)parseInt(d.events[e].year)<d.startYear&&(d.startYear=parseInt(d.events[e].year));d.nYears=d.endYear-d.startYear+1,d.nMonths=Math.ceil((d.endDate-d.startDate)/d.months),d.nDays=Math.ceil((d.endDate-d.startDate)/d.days)},b.prototype.parseXML=function(){for(var b,c,d,e=this,f=e.xmlDoc.getElementsByTagName(e.eventTagName),g=0;g<f.length;g++){var h=a(f[g]).find(e.dateTagName).text(),i=h.split(".");b=i[0],d=i[1],c=parseInt(i[2]);var j=0;j=0==parseInt(b[0])?parseInt(b[1]):parseInt(b);var k=0;k=0==parseInt(d[0])?parseInt(d[1]):parseInt(d);var l=30,m=a(f[g]).find(e.titleTagName).text();m.length>l&&(m=m.slice(0,l),m+="...");var n=!1;if(0!=a(f[g]).find(e.thumbTagName).length){n=!0;var o='<img src="'+a(f[g]).find(e.thumbTagName).text()+'">'}var p=400,q=a(f[g]).find(e.contentTagName).text();q.length>p&&(q=q.slice(0,p),q+="..."),e.events[g]={id:g,date:j,year:c,month:k,title:m,content:q,link:a(f[g]).find(e.linkTagName).find("a"),hasThumb:n,thumb:o}}for(var g=0;g<e.events.length;g++)parseInt(e.events[g].year)>e.endYear&&(e.endYear=parseInt(e.events[g].year));for(var g=0;g<e.events.length;g++)parseInt(e.events[g].year)<e.startYear&&(e.startYear=parseInt(e.events[g].year));e.nYears=e.endYear-e.startYear+1,e.nMonths=Math.ceil((e.endDate-e.startDate)/e.months),e.nDays=Math.ceil((e.endDate-e.startDate)/e.days)},b.prototype.parseHTML=function(){for(var b,c,d,e=this,f=a(".timeline-event"),g=0;g<f.length;g++){var h=a(f[g]).find("."+e.htmlDateClassName).html(),i=h.split(".");b=i[0],d=i[1],c=parseInt(i[2]);var j=0;j=0==parseInt(b[0])?parseInt(b[1]):parseInt(b);var k=0;k=0==parseInt(d[0])?parseInt(d[1]):parseInt(d);var l=30,m=a(f[g]).find("."+e.htmlTitleClassName).html();m.length>l&&(m=m.slice(0,l),m+="...");var n=!1;if(0!=a(f[g]).find("."+e.htmlThumbClassName).length){n=!0;var o='<img src="'+a(f[g]).find("."+e.htmlThumbClassName).html()+'">'}var p=400,q=a(f[g]).find("."+e.htmlContentClassName).html();q.length>p&&(q=q.slice(0,p),q+="..."),e.events[g]={id:g,date:j,year:c,month:k,title:m,content:q,link:a(f[g]).find("."+e.htmlLinkClassName).find("a"),hasThumb:n,thumb:o}}for(var g=0;g<e.events.length;g++)parseInt(e.events[g].year)>e.endYear&&(e.endYear=parseInt(e.events[g].year));for(var g=0;g<e.events.length;g++)parseInt(e.events[g].year)<e.startYear&&(e.startYear=parseInt(e.events[g].year));e.nYears=e.endYear-e.startYear+1,e.nMonths=Math.ceil((e.endDate-e.startDate)/e.months),e.nDays=Math.ceil((e.endDate-e.startDate)/e.days)},c.prototype.init=function(b){var c=this;c.target=b.target,c.width=c.target.outerWidth(),c.yearWidth=c.width/e.nYears,e.nYears%2!=0&&Math.round(c.width/c.yearWidth/12)&&(e.nYears++,c.yearWidth=c.width/e.nYears),c.monthWidth=c.yearWidth/12,c.dayWidth=c.monthWidth/30,"html"===b.mode&&a(".timeline-html-wrap").hide(),c.target.after().append('<div class="timeline-event-node"></div>'),c.eventNodeWidth=a(".timeline-event-node").first().outerWidth(),a(".timeline-event-node").remove(),c.monthWidth<=8?c.showMonths=!1:c.showMonths=!0,c.showEveryNthMonth=Math.round(c.width/c.monthWidth/12),c.showEveryNthMonth=c.showEveryNthMonth-c.showEveryNthMonth%2,1==e.nYears&&(c.showEveryNthMonth=1),c.yearWidth>c.width?c.showYears=!1:c.showYears=!0,c.showEveryNthYear=Math.round(c.width/c.yearWidth/12);for(var d=c.showEveryNthYear+"",f=1,g=0;g<d.length-1;g++)f+="0";c.showEveryNthYear=Math.round(c.showEveryNthYear/parseInt(f))*parseInt(f),c.showEveryNthYear=c.showEveryNthYear<1?1:c.showEveryNthYear,c.nLargeScale=e.nYears,c.nSmallScale=e.nMonths,c.step=c.monthWidth/30},c.prototype.drawEvents=function(){var a=this,b='<div class="timeline-wrap">';b+='	<div class="timeline-events">',b+='	<div class="timeline-years timeline-large-scale"></div>',b+='	<div class="timeline-months timeline-small-scale"></div>';for(var c=0;c<e.events.length;c++)b+='		<div class="timeline-event timeline-bottom" id="timeline-event-'+e.events[c].id+'">',b+='			<div class="timeline-event-node" id="timeline-event-node-'+e.events[c].id+'"></div>',b+='			<div class="timeline-event-arrow"></div>',b+='			<div class="timeline-event-contents">',0!=e.events[c].title&&(b+='			<div class="timeline-event-title"><span>'+e.events[c].datestring+"</span>"+e.events[c].title+"</div>"),0!=e.events[c].content&&(b+='			<div class="timeline-event-content">',e.events[c].hasThumb&&(b+=e.events[c].thumb),b+=e.events[c].content+"</div>"),e.events[c].link&&(b+='			<div class="timeline-event-link">'+e.events[c].link+"</div>"),b+="			</div>",b+="		</div>";b+="	</div>",b+="</div>",a.target.html(b)},c.prototype.setData=function(){for(var b=0,c=0,d=0;d<e.events.length;d++)b=a("#timeline-event-"+e.events[d].id),c=b.find(".timeline-event-contents"),c.show(),b.data({offset:c.offset().left,smallWidth:c.width(),margin:parseInt(b.find(".timeline-event-contents").css("margin-left").replace("px",""))}),c.hide()},c.prototype.addDates=function(){var a=this;if(a.showYears)for(var b=0;b<e.nYears+1;b++){if(b<e.nYears)for(var c=0;12>c;c++)a.addMonth();a.addYear()}},c.prototype.addMonth=function(){var b=this;b.monthId%12!=0&&b.showMonths&&(b.monthId%b.showEveryNthMonth==0?a(".timeline-months").append('<div class="timeline-month timeline-dateblock" id="timeline-month-'+b.monthId+'">'+e.allMonths[b.monthId%12]+"</div>"):a(".timeline-months").append('<div class="timeline-month timeline-dateblock" id="timeline-month-'+b.monthId+'"></div>'),a("#timeline-month-"+b.monthId).css({left:h.lim(b.monthPosition,0,b.width)})),b.monthPosition+=b.monthWidth,b.monthId++},c.prototype.addYear=function(){var b=this;if(b.showYears&&b.yearId%b.showEveryNthYear==0){var c=new Array;c=e.startYear+b.yearId+"",0>c&&(c=c.replace("-","")+" BC"),a(".timeline-years").append('<div class="timeline-year timeline-dateblock" id="timeline-year-'+b.yearId+'">'+c+"</div>"),a("#timeline-year-"+b.yearId).css({left:h.lim(b.yearPosition,0,b.width-1)})}b.yearPosition+=b.yearWidth,b.yearId++},c.prototype.positionEvents=function(){function b(a,b){return a.position-b.position}for(var c=0;c<e.events.length;c++)e.events[c].position=f.getPosition(c);var d=new Array;for(c=0;c<e.events.length;c++)d[c]=e.events[c];e.events.sort(b);var g=0;for(c=1;c<e.events.length;c++)e.events[c].position<=e.events[c-1].position&&(e.events[c].position=e.events[c-1].position),Math.abs(e.events[c].position-e.events[c-1].position)<f.eventNodeWidth&&(g=Math.abs(e.events[c].position-e.events[c-1].position),e.events[c].position=e.events[c-1].position+f.eventNodeWidth/1.5);if(e.events[e.events.length-1]){if(e.events[e.events.length-1].position>root.width){e.events[e.events.length-1].position=root.width;for(var c=e.events.length-1;c>0;c--)e.events[c-1].position>=e.events[c].position&&(e.events[c-1].position=e.events[c].position),Math.abs(e.events[c].position-e.events[c-1].position)<f.eventNodeWidth&&(g=Math.abs(e.events[c].position-e.events[c-1].position),e.events[c-1].position=e.events[c-1].position-f.eventNodeWidth/1.5),e.events[c].position=e.events[c].position-f.eventNodeWidth/2}for(root.drawEvents(),root.setData(),c=0;c<e.events.length;c++)a("#timeline-event-"+e.events[c].id).css({left:e.events[c].position,"z-index":c})}},c.prototype.getPosition=function(a){root=this;var b=0;return b=root.monthWidth*(e.events[a].month-1)+root.yearWidth*(e.events[a].year-e.startYear)+root.dayWidth*(e.events[a].date-1)-f.eventNodeWidth/2-1,root.eventPositions[a]=b,b},c.prototype.showEvent=function(b){var c=this,d=a("#"+b),e=d.find(".timeline-event-contents");c.aboveTimeline(d)&&d.addClass("timeline-above"),d.addClass("timeline-hover").find(".timeline-event-contents").fadeIn(200),d.find(".timeline-event-arrow").fadeIn(200),d.data({offset:e.offset().left,showed:!0}),this.needMargin(d)&&this.correctMargin(d)},c.prototype.hideEvent=function(b){var c=a("#"+b);c.removeClass("timeline-hover").find(".timeline-event-contents").fadeOut(200,function(){a(this).closest(".timeline-above").removeClass("timeline-above"),c.find(".timeline-event-contents").css({"margin-left":c.data("margin")})}),c.removeClass("timeline-hover").find(".timeline-event-arrow").fadeOut(200),c.data({showed:!1})},c.prototype.selectEvent=function(b){var c=this;b.find(".timeline-event-contents");if(b.removeClass("timeline-above").addClass("timeline-selected").removeClass("timeline-hover"),c.selectedEvent=b,b.data("showed")||c.showEvent(b.attr("id")),this.needMargin(b,400))var d=b.data("offset")+400-(a(".timeline-wrap").offset().left+a(".timeline-wrap").outerWidth()),e=-d+b.data("margin");else var e=b.data("margin");b.find(".timeline-event-contents").fadeIn(200).animate({width:376,"margin-left":e},100,function(){b.find(".timeline-event-content").slideDown(200),b.find(".timeline-event-link").fadeIn(200)})},c.prototype.deselectEvent=function(){var b=this,c=a(".timeline-wrap").find(".timeline-selected");b.hideEvent(c.attr("id")),c.removeClass("timeline-selected"),c.find(".timeline-event-content").slideUp(200,function(){c.find(".timeline-event-contents").css({width:c.data("smallWidth"),"margin-left":c.data("margin")})}),c.find(".timeline-event-link").fadeOut(200),b.selectedEvent=0},c.prototype.aboveTimeline=function(a){var b=this;return 0==b.selectedEvent||a.hasClass("timeline-selected")?!1:!0},c.prototype.needMargin=function(b,c){return c=void 0===c?b.find(".timeline-event-contents").outerWidth():400,b.data("offset")+c>a(".timeline-wrap").offset().left+a(".timeline-wrap").outerWidth()?!0:!1},c.prototype.correctMargin=function(b,c,d){c=void 0===c?b.find(".timeline-event-contents").outerWidth():400;var e=b.data("offset")+c-(a(".timeline-wrap").offset().left+a(".timeline-wrap").outerWidth());d?b.find(".timeline-event-contents").animate({"margin-left":-e+b.data("margin")},100):b.find(".timeline-event-contents").css({"margin-left":-e+b.data("margin")})},d.prototype.setDOMEvents=function(){var b=this;a(".timeline-event-node").on("click",function(){0==f.selectedEvent?f.selectEvent(a(this).parent()):a(this).parent().hasClass("timeline-selected")?f.deselectEvent(a(this).parent()):(f.deselectEvent(a(".timeline-selected")),f.selectEvent(a(this).parent()))}),a(".timeline-event-node").on("mouseover",function(){0==a(".timeline-selected").length&&f.hideEvent(a(".timeline-hover").attr("id")),a(this).closest(".timeline-event").hasClass("timeline-hover")||f.showEvent(a(this).closest(".timeline-event").attr("id"))}),a(".timeline-event-node").on("mouseout",function(){a(this).closest(".timeline-event").hasClass("timeline-selected")||f.hideEvent(a(this).closest(".timeline-event").attr("id"))}),a(document).on("click",function(c){0!=b.selectedEvent&&0==a(c.target).closest(".timeline-wrap").length&&f.deselectEvent()})},a.fn.extend({timelinexml:function(h){var i=a.extend({src:"",showLatest:!1,selectLatest:!1,eventTagName:"event",dateTagName:"date",titleTagName:"title",thumbTagName:"thumb",contentTagName:"content",linkTagName:"link",mode:"xml",htmlEventClassName:"timeline-event",htmlDateClassName:"timeline-date",htmlTitleClassName:"timeline-title",htmlContentClassName:"timeline-content",htmlLinkClassName:"timeline-link",htmlThumbClassName:"timeline-thumb"},h);return e=new b(i),f=new c,g=new d,this.each(function(){var b=a(this);0!=a(i.src).length?(i.mode="html",e.getHTMLContent(),e.parseRawData(),f.init({target:b,mode:"html"}),f.positionEvents(),f.addDates(),g.setDOMEvents(),(i.showLatest||i.selectLatest)&&(f.showEvent("timeline-event-0"),i.selectLatest&&setTimeout(function(){f.selectEvent(a("#timeline-event-0"))},500))):e.loadXML({callback:function(){e.getXMLContent(),e.parseRawData(),f.init({target:b}),f.positionEvents(),f.addDates(),g.setDOMEvents(),(i.showLatest||i.selectLatest)&&(f.showEvent("timeline-event-0"),i.selectLatest&&setTimeout(function(){f.selectEvent(a("#timeline-event-0"))},500))}})})}})}(jQuery);